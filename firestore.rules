rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user has a specific role
    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // User profiles collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if request.auth != null;
      // Users can only write to their own profile
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Only participants can read chat metadata
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participants;
      // Participants can update chat metadata (for last message, etc.)
      allow write: if request.auth != null && 
                      request.auth.uid in request.resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Only chat participants can read messages
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        // Only the sender can create messages
        allow create: if request.auth != null && 
                         request.auth.uid == request.resource.data.senderId &&
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        // Messages are immutable - no updates or deletes allowed
        allow update, delete: if false;
      }
    }
    
    // Stories collection
    match /stories/{storyId} {
      // Anyone authenticated can read non-expired stories
      allow read: if request.auth != null;
      // Only the story owner can create stories
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      // Stories cannot be updated after creation
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userId &&
                       // Only allow updating viewerIds (for view tracking)
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewerIds']);
      // Only the story owner can delete their stories
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.userId;
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Users can read their own reports, moderators can read all
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.reporterId || hasRole('moderator'));
      // Anyone authenticated can create reports
      allow create: if request.auth != null;
      // Only moderators can update report status
      allow update: if request.auth != null && hasRole('moderator');
      // Reports cannot be deleted
      allow delete: if false;
    }
    
    // Blocks collection
    match /blocks/{blockId} {
      // Only the blocker can read their blocks
      allow read: if request.auth != null && 
                     request.auth.uid == resource.data.blockerId;
      // Only the blocker can create/delete blocks
      // Block ID format: {blockerId}_{blockedUserId}
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.blockerId &&
                       blockId == request.resource.data.blockerId + '_' + request.resource.data.blockedUserId;
      // Blocks cannot be updated, only created or deleted
      allow update: if false;
      allow delete: if request.auth != null && 
                       request.auth.uid == resource.data.blockerId;
    }
    
    // Anonymous links collection
    match /anonymous_links/{linkId} {
      // Anyone can read anonymous links (to view profiles anonymously)
      allow read: if true;
      // Only authenticated users can create anonymous links for themselves
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.userId;
      // Anonymous links cannot be updated or deleted
      allow update, delete: if false;
    }
  }
}
