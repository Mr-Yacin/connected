# ุฅุตูุงุญ ูุดููุฉ Switch ุงูุฅุดุนุงุฑุงุช ๐ง

## ุงูุชุงุฑูุฎ: 4 ุฏูุณูุจุฑ 2025

---

## ๐ ุงููุดููุฉ

**ุงูุฃุนุฑุงุถ:**
- Switch ูุง ูุชุบูุฑ ุนูุฏ ุงูุถุบุท ุนููู
- ูุจูู ูู ูุถุน ON
- ููู Snackbar ูุธูุฑ "ุชู ุชุนุทูู ุงูุฅุดุนุงุฑุงุช"
- ุงูุจูุงูุงุช ูุง ุชูุญุฏุซ ูู Firestore ุจุดูู ุตุญูุญ

**ุงูุณุจุจ:**
ุงููุดููุฉ ูุงูุช ูู ุทุฑููุฉ ุชุญุฏูุซ ุญูู `settings` ูู Firestore. ุงูููุฏ ุงููุฏูู ูุงู ูุณุชุฎุฏู:
```dart
await _firestore.collection('users').doc(currentUser.uid).update({
  'settings.$key': value,
});
```

ูุฐุง ููุดู ุฅุฐุง ูุงู ุญูู `settings` ุบูุฑ ููุฌูุฏ ุฃุตูุงู ูู ุงููุณุชูุฏ!

---

## โ ุงูุญู

### 1. ุชุญุฏูุซ UserDataService

**ุงูููู:** `lib/services/external/user_data_service.dart`

**ูุจู:**
```dart
await _firestore.collection('users').doc(currentUser.uid).update({
  'settings.$key': value,
});
```

**ุจุนุฏ:**
```dart
// Use set with merge to create settings field if it doesn't exist
await _firestore.collection('users').doc(currentUser.uid).set({
  'settings': {
    key: value,
  },
}, SetOptions(merge: true));
```

**ุงููุงุฆุฏุฉ:**
- โ ููุดุฆ ุญูู `settings` ุฅุฐุง ูู ููู ููุฌูุฏุงู
- โ ูุญุฏุซ ุงูุญูู ุฅุฐุง ูุงู ููุฌูุฏุงู
- โ ูุง ูุญุฐู ุงูุญููู ุงูุฃุฎุฑู (ุจุณุจุจ `merge: true`)

---

### 2. ุชุญุณูู UI ูู SettingsScreen

**ุงูููู:** `lib/features/settings/presentation/screens/settings_screen.dart`

**ุงูุชุญุณููุงุช:**

#### ุฃ. ุฅุถุงูุฉ loading state
```dart
// ูุจู
final currentUserProfile = ref.watch(currentUserProfileProvider).profile;

// ุจุนุฏ
final currentUserProfileState = ref.watch(currentUserProfileProvider);
final currentUserProfile = currentUserProfileState.profile;
```

#### ุจ. ุชุนุทูู Switch ุฃุซูุงุก ุงูุชุญุฏูุซ
```dart
// ูุจู
onChanged: (value) async { ... }

// ุจุนุฏ
onChanged: currentUserProfileState.isLoading ? null : (value) async { ... }
```

#### ุฌ. ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุงูุฎุทุฃ
```dart
catch (e) {
  if (context.mounted) {
    SnackbarHelper.showError(context, 'ูุดู ูู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช');
  }
  // Refresh to revert UI to correct state
  await ref
      .read(currentUserProfileProvider.notifier)
      .loadCurrentUserProfile();
}
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ูุณุชุฎุฏู ุฌุฏูุฏ (ุจุฏูู settings)
```
ุงูุฎุทูุงุช:
1. ุงูุชุญ ุงูุฅุนุฏุงุฏุงุช
2. ุงุถุบุท ุนูู Switch
3. ุชุญูู ูู Firestore

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ Switch ูุชุบูุฑ ุฅูู ON
โ ูุธูุฑ "ุชู ุชูุนูู ุงูุฅุดุนุงุฑุงุช"
โ ูู Firestore ูุธูุฑ:
{
  "settings": {
    "notifyOnProfileView": true
  }
}
```

### ุงุฎุชุจุงุฑ 2: ูุณุชุฎุฏู ูุฏูู (ูุน settings)
```
ุงูุฎุทูุงุช:
1. ุงูุชุญ ุงูุฅุนุฏุงุฏุงุช
2. ุงุถุบุท ุนูู Switch
3. ุชุญูู ูู Firestore

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ Switch ูุชุบูุฑ
โ ูุธูุฑ ุฑุณุงูุฉ ุงูุชุฃููุฏ
โ ูู Firestore ูุชุญุฏุซ ุงูุญูู ููุท
โ ุงูุญููู ุงูุฃุฎุฑู ูุง ุชุชุฃุซุฑ
```

### ุงุฎุชุจุงุฑ 3: ุฎุทุฃ ูู ุงูุดุจูุฉ
```
ุงูุฎุทูุงุช:
1. ูุทุน ุงูุฅูุชุฑูุช
2. ุงุถุบุท ุนูู Switch
3. ุฃุนุฏ ุงูุฅูุชุฑูุช

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
โ Switch ูุฑุฌุน ููุญุงูุฉ ุงูุตุญูุญุฉ
โ ูุง ูุญุฏุซ crash
```

---

## ๐ ููู ูุนูู ุงูุขู

### ุงูุชุฏูู ุงููุงูู:

```
1. ุงููุณุชุฎุฏู ูุถุบุท ุนูู Switch
   โ
2. UI ุชุนุทู Switch (isLoading = true)
   โ
3. updateNotificationSetting() ููุณุชุฏุนู
   โ
4. Firestore ููุญุฏุซ ุจู set + merge
   โ
5. loadCurrentUserProfile() ููุณุชุฏุนู
   โ
6. UI ุชุชุญุฏุซ ุจุงููููุฉ ุงูุฌุฏูุฏุฉ
   โ
7. Snackbar ูุธูุฑ ุฑุณุงูุฉ ุงูุชุฃููุฏ
   โ
8. Switch ูููุนูู ูุฑุฉ ุฃุฎุฑู
```

### ูู ุญุงูุฉ ุงูุฎุทุฃ:

```
1. ุงููุณุชุฎุฏู ูุถุบุท ุนูู Switch
   โ
2. UI ุชุนุทู Switch
   โ
3. updateNotificationSetting() ููุดู
   โ
4. catch block ููุณุชุฏุนู
   โ
5. Snackbar ูุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
   โ
6. loadCurrentUserProfile() ููุณุชุฏุนู
   โ
7. UI ุชุฑุฌุน ููุญุงูุฉ ุงูุตุญูุญุฉ
   โ
8. Switch ูููุนูู ูุฑุฉ ุฃุฎุฑู
```

---

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

### ูู Firebase Console:

1. ุงูุชุญ Firestore Database
2. ุงุฐูุจ ุฅูู collection `users`
3. ุงูุชุญ ูุณุชูุฏ ุงููุณุชุฎุฏู
4. ูุฌุจ ุฃู ุชุฑู:

```json
{
  "id": "user123",
  "name": "ุฃุญูุฏ",
  "age": 25,
  "settings": {
    "notifyOnProfileView": true
  }
}
```

### ูู ุงูุชุทุจูู:

1. ุงูุชุญ ุงูุฅุนุฏุงุฏุงุช
2. ุงุถุบุท ุนูู Switch ุนุฏุฉ ูุฑุงุช
3. ูุฌุจ ุฃู:
   - โ Switch ูุชุบูุฑ ููุฑุงู
   - โ ุฑุณุงูุฉ ุงูุชุฃููุฏ ุชุธูุฑ
   - โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู console
   - โ ุงููููุฉ ุชูุญูุธ ูู Firestore

---

## ๐ก ูุตุงุฆุญ ุฅุถุงููุฉ

### ูููุทูุฑูู:

1. **ุงุณุชุฎุฏู `set` ูุน `merge: true` ุจุฏูุงู ูู `update`**
   - ุฃูุซุฑ ุฃูุงูุงู
   - ูุนูู ุญุชู ูู ุงูุญูู ุบูุฑ ููุฌูุฏ
   - ูุง ูุญุฐู ุงูุญููู ุงูุฃุฎุฑู

2. **ุฃุถู loading state ุฏุงุฆูุงู**
   - ูููุน ุงููุณุชุฎุฏู ูู ุงูุถุบุท ุนุฏุฉ ูุฑุงุช
   - ูุนุทู feedback ุจุตุฑู
   - ูุญุณู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

3. **ุฃุนุฏ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุงูุฎุทุฃ**
   - ูุถูู ุฃู UI ูุชุฒุงููุฉ ูุน Backend
   - ูููุน ุญุงูุงุช ุบูุฑ ูุชููุนุฉ
   - ูุญุณู ุงูููุซูููุฉ

### ููุงุฎุชุจุงุฑ:

1. **ุงุฎุชุจุฑ ูุน ูุณุชุฎุฏููู ุฌุฏุฏ ููุฏุงูู**
2. **ุงุฎุชุจุฑ ูุน ูุจุฏูู ุฅูุชุฑูุช**
3. **ุงุฎุชุจุฑ ุงูุถุบุท ุงูุณุฑูุน ุงููุชูุฑุฑ**
4. **ุชุญูู ูู Firestore ุจุนุฏ ูู ุงุฎุชุจุงุฑ**

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `lib/services/external/user_data_service.dart`
- โ ุชุบููุฑ ูู `update()` ุฅูู `set()` ูุน `merge: true`
- โ ุฅูุดุงุก ุญูู `settings` ุชููุงุฆูุงู ุฅุฐุง ูู ููู ููุฌูุฏุงู

### 2. `lib/features/settings/presentation/screens/settings_screen.dart`
- โ ุฅุถุงูุฉ loading state
- โ ุชุนุทูู Switch ุฃุซูุงุก ุงูุชุญุฏูุซ
- โ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุงูุฎุทุฃ

---

## โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ุงููุดููุฉ:** Switch ูุง ูุชุบูุฑ โ

**ุงูุญู:** 
- โ Switch ูุชุบูุฑ ููุฑุงู
- โ ุงูุจูุงูุงุช ุชูุญูุธ ูู Firestore
- โ ุฑุณุงุฆู ุงูุชุฃููุฏ ุชุธูุฑ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุชุนูู
- โ UI ูุชุฒุงููุฉ ูุน Backend

**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุงุฎุชุจุฑ ุงูุชุทุจูู
2. โ ุชุญูู ูู Firestore
3. โ ุชุฃูุฏ ูู ุนูู Switch ุจุดูู ุตุญูุญ
4. โ๏ธ ููุฐ ููุฒุฉ ุชุณุฌูู ุงูุฒูุงุฑุงุช
5. โ๏ธ ุฃุถู FCM
6. โ๏ธ ุฃุฑุณู ุงูุฅุดุนุงุฑุงุช ุงููุนููุฉ

---

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:
1. ุชุญูู ูู console ููุฃุฎุทุงุก
2. ุชุญูู ูู Firestore Rules
3. ุชุญูู ูู ุงูุฅูุชุฑูุช
4. ุฑุงุฌุน logs ูู Firebase Console

ูู ุดูุก ูุฌุจ ุฃู ูุนูู ุงูุขู! ๐
