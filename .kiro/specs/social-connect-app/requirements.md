# مستند المتطلبات - تطبيق التواصل الاجتماعي

## المقدمة

تطبيق تواصل اجتماعي وتعارف موجه للسوق العربي، يجمع بين الخصوصية والأمان مع ميزات اجتماعية حديثة. يوفر التطبيق بيئة آمنة تراعي العادات والقيم المحلية، مع إمكانية التواصل المجهول الاختياري.

## المصطلحات

- **النظام**: تطبيق التواصل الاجتماعي المطور باستخدام Flutter و Firebase
- **المستخدم**: أي شخص مسجل في التطبيق
- **OTP**: رمز التحقق لمرة واحدة (One-Time Password)
- **الشفل**: نظام الاستكشاف العشوائي للمستخدمين
- **القصص**: محتوى مؤقت يظهر لمدة 24 ساعة
- **التمويه**: خاصية إخفاء الصورة الشخصية جزئياً
- **المشرف**: مسؤول النظام الذي يدير المحتوى والمستخدمين

## المتطلبات

### المتطلب 1: التوثيق والتسجيل الآمن

**قصة المستخدم:** كمستخدم جديد، أريد التسجيل في التطبيق بشكل آمن باستخدام رقم هاتفي، حتى أتمكن من إنشاء حساب موثوق.

#### معايير القبول

1. WHEN المستخدم يدخل رقم هاتف صالح THEN النظام SHALL يرسل رمز OTP إلى ذلك الرقم
2. WHEN المستخدم يدخل رمز OTP صحيح THEN النظام SHALL يقوم بإنشاء حساب جديد أو تسجيل الدخول للحساب الموجود
3. WHEN المستخدم يدخل رمز OTP خاطئ ثلاث مرات متتالية THEN النظام SHALL يمنع المحاولات لمدة 5 دقائق
4. WHEN المستخدم يطلب إعادة إرسال رمز OTP THEN النظام SHALL يرسل رمز جديد بعد مرور 60 ثانية من الطلب السابق
5. THE النظام SHALL يحفظ معلومات الجلسة بشكل آمن باستخدام Firebase Authentication

### المتطلب 2: إدارة الملف الشخصي

**قصة المستخدم:** كمستخدم، أريد التحكم في ظهور معلوماتي الشخصية وصورتي، حتى أحافظ على خصوصيتي.

#### معايير القبول

1. WHEN المستخدم يقوم برفع صورة شخصية THEN النظام SHALL يحفظ الصورة في Firebase Storage ويربطها بالملف الشخصي
2. WHEN المستخدم يفعّل خيار التمويه THEN النظام SHALL يطبق تأثير blur على الصورة الشخصية عند عرضها للآخرين
3. WHEN المستخدم يقوم بإنشاء رابط شخصي مجهول THEN النظام SHALL يولد رابط فريد يمكن مشاركته دون الكشف عن الهوية
4. THE النظام SHALL يسمح للمستخدم بتحديث الاسم والعمر والدولة واللهجة في أي وقت
5. WHEN المستخدم يحفظ تغييرات الملف الشخصي THEN النظام SHALL يحدّث البيانات في Firestore فوراً

### المتطلب 3: نظام الدردشة والرسائل

**قصة المستخدم:** كمستخدم، أريد التواصل مع مستخدمين آخرين عبر الرسائل النصية والصوتية، حتى أتمكن من بناء علاقات اجتماعية.

#### معايير القبول

1. WHEN المستخدم يرسل رسالة نصية THEN النظام SHALL يحفظ الرسالة في Firestore ويرسلها للمستقبل في الوقت الفعلي
2. WHEN المستخدم يسجل رسالة صوتية THEN النظام SHALL يحفظ الملف الصوتي في Firebase Storage ويرسل رابطه للمستقبل
3. WHEN المستخدم يستقبل رسالة جديدة WHILE التطبيق مفتوح THEN النظام SHALL يعرض الرسالة فوراً دون الحاجة لتحديث الصفحة
4. WHEN المستخدم يستقبل رسالة جديدة WHILE التطبيق مغلق THEN النظام SHALL يرسل إشعار push notification
5. THE النظام SHALL يعرض الرسائل مرتبة حسب الوقت من الأقدم للأحدث

### المتطلب 4: نظام الاستكشاف (الشفل)

**قصة المستخدم:** كمستخدم، أريد اكتشاف مستخدمين جدد بشكل عشوائي أو حسب معايير محددة، حتى أتمكن من توسيع دائرة معارفي.

#### معايير القبول

1. WHEN المستخدم يضغط على زر الشفل THEN النظام SHALL يعرض ملف شخصي عشوائي لمستخدم آخر
2. WHEN المستخدم يطبق فلتر البحث حسب الدولة THEN النظام SHALL يعرض فقط المستخدمين من تلك الدولة
3. WHEN المستخدم يطبق فلتر البحث حسب اللهجة THEN النظام SHALL يعرض فقط المستخدمين الذين يتحدثون تلك اللهجة
4. WHEN المستخدم يطبق فلاتر متعددة THEN النظام SHALL يعرض المستخدمين الذين يطابقون جميع الفلاتر المحددة
5. THE النظام SHALL يستثني المستخدمين المحظورين من نتائج الاستكشاف

### المتطلب 5: القصص (Stories)

**قصة المستخدم:** كمستخدم، أريد نشر ومشاهدة قصص مؤقتة، حتى أشارك لحظاتي اليومية وأتفاعل مع الآخرين.

#### معايير القبول

1. WHEN المستخدم ينشر قصة جديدة THEN النظام SHALL يحفظ القصة مع timestamp وتاريخ انتهاء بعد 24 ساعة
2. WHEN مرور 24 ساعة على نشر القصة THEN النظام SHALL يحذف القصة تلقائياً من قاعدة البيانات
3. WHEN المستخدم يشاهد قصة THEN النظام SHALL يسجل المشاهدة ويعرضها لصاحب القصة
4. THE النظام SHALL يعرض القصص في شريط أفقي في الشاشة الرئيسية مرتبة حسب الأحدث
5. WHEN المستخدم يضغط على قصة THEN النظام SHALL يعرض القصة في وضع ملء الشاشة مع إمكانية التنقل بين القصص

### المتطلب 6: الأمان والإبلاغ

**قصة المستخدم:** كمستخدم، أريد حظر المستخدمين المزعجين والإبلاغ عن المحتوى غير اللائق، حتى أحافظ على تجربة استخدام آمنة.

#### معايير القبول

1. WHEN المستخدم يحظر مستخدم آخر THEN النظام SHALL يمنع ذلك المستخدم من إرسال رسائل أو رؤية الملف الشخصي
2. WHEN المستخدم يبلغ عن محتوى غير لائق THEN النظام SHALL يحفظ البلاغ مع تفاصيله ويرسله للمشرفين
3. WHEN المشرف يراجع بلاغ THEN النظام SHALL يعرض المحتوى المبلغ عنه مع معلومات المستخدم المبلغ والمبلغ عنه
4. WHEN المشرف يتخذ إجراء على بلاغ THEN النظام SHALL يحدّث حالة البلاغ ويطبق الإجراء المناسب (تحذير، حظر، حذف محتوى)
5. THE النظام SHALL يحتفظ بسجل كامل لجميع البلاغات والإجراءات المتخذة

### المتطلب 7: دعم اللغة العربية والواجهة

**قصة المستخدم:** كمستخدم عربي، أريد استخدام التطبيق بلغتي الأم مع واجهة تدعم الاتجاه من اليمين لليسار، حتى أحصل على تجربة مريحة وطبيعية.

#### معايير القبول

1. THE النظام SHALL يعرض جميع النصوص والواجهات باللغة العربية بشكل افتراضي
2. THE النظام SHALL يدعم الاتجاه من اليمين لليسار (RTL) في جميع الشاشات
3. THE النظام SHALL يوفر وضع الظلام (Dark Mode) كخيار افتراضي
4. WHEN المستخدم يغير إعدادات اللغة أو الوضع THEN النظام SHALL يحفظ التفضيلات ويطبقها فوراً
5. THE النظام SHALL يستخدم خطوط عربية واضحة ومقروءة في جميع العناصر

### المتطلب 8: إدارة البيانات والتخزين

**قصة المستخدم:** كمطور نظام، أريد تخزين وإدارة البيانات بشكل فعال وآمن، حتى يعمل التطبيق بسلاسة ويحافظ على خصوصية المستخدمين.

#### معايير القبول

1. WHEN النظام يحفظ بيانات مستخدم THEN النظام SHALL يستخدم Firestore لتخزين البيانات النصية المنظمة
2. WHEN النظام يحفظ ملفات وسائط (صور، صوت) THEN النظام SHALL يستخدم Firebase Storage مع تشفير الملفات
3. WHEN المستخدم يحذف حسابه THEN النظام SHALL يحذف جميع بياناته الشخصية والمحتوى المرتبط به خلال 30 يوم
4. THE النظام SHALL يطبق قواعد أمان Firebase لمنع الوصول غير المصرح به للبيانات
5. WHEN النظام يقرأ بيانات في الوقت الفعلي THEN النظام SHALL يستخدم Firestore snapshots للحصول على تحديثات فورية

---

## المتطلبات المستقبلية (Future Requirements)

### المتطلب 9: مكالمات الصوت والفيديو (Future - Not Implemented Yet)

**حالة:** مخطط - سيتم التنفيذ عند الوصول إلى 50K+ مستخدم  
**قصة المستخدم:** كمستخدم، أريد إجراء مكالمات صوتية ومرئية مع جهات الاتصال، حتى أتمكن من التواصل بشكل أفضل.

#### معايير القبول

1. WHEN المستخدم يبدأ مكالمة صوتية مع جهة اتصال THEN النظام SHALL يستخدم WebRTC لإنشاء اتصال peer-to-peer
2. WHEN المستخدم يبدأ مكالمة فيديو THEN النظام SHALL يطلب إذن الكاميرا والمايكروفون ويبدأ stream الفيديو
3. WHEN المستخدم يستقبل طلب مكالمة WHILE التطبيق مفتوح THEN النظام SHALL يعرض واجهة incoming call مع خيارات القبول/الرفض
4. WHEN المستخدم يستقبل طلب مكالمة WHILE التطبيق مغلق THEN النظام SHALL يرسل push notification مع call notification UI
5. WHEN المكالمة نشطة THEN النظام SHALL يعرض مؤشرات لجودة الاتصال وزمن المكالمة
6. WHEN المستخدم يضغط زر كتم الصوت THEN النظام SHALL يوقف إرسال الصوت مع إبقاء المكالمة نشطة
7. WHEN المستخدم يضغط زر إيقاف الفيديو THEN النظام SHALL يوقف إرسال الفيديو ويعرض صورة ثابتة
8. WHEN أحد الطرفين ينهي المكالمة THEN النظام SHALL يغلق الاتصال ويحفظ سجل المكالمة
9. WHEN جودة الشبكة ضعيفة THEN النظام SHALL يقلل جودة الفيديو تلقائياً للحفاظ على الاتصال
10. THE النظام SHALL يدعم مكالمات جماعية حتى 8 مشاركين (اختياري)

#### التقنيات المقترحة

**WebRTC (Web Real-Time Communication):**
- معيار مفتوح لاتصالات الوقت الفعلي
- دعم متصفحات ومنصات متعددة
- اتصال P2P مباشر (بدون سيرفر وسيط لتقليل التكلفة)

**Signaling Server:**
- استخدام Firebase Firestore لتبادل ICE candidates و SDP offers
- أو استخدام WebSocket server مخصص للأداء الأفضل
- Socket.io أو Pusher كبدائل

**TURN/STUN Servers (للاتصال خلف NAT/Firewall):**
- استخدام Google STUN servers (مجاني)
  - `stun:stun.l.google.com:19302`
- استخدام TURN server مدفوع عند الضرورة
  - Twilio TURN servers
  - Xirsys
  - coturn (self-hosted)

**Call Quality Management:**
- استخدام adaptive bitrate للفيديو
- تقليل resolution عند ضعف الشبكة
- تفضيل الصوت على الفيديو في الاتصالات الضعيفة

#### اعتبارات التكلفة

**التكلفة المتوقعة (1000 مستخدم نشط):**

| الخدمة | الاستخدام | التكلفة الشهرية |
|--------|-----------|-----------------|
| STUN Server | مجاني (Google) | $0 |
| TURN Server | 10% من المكالمات تحتاج TURN | $20 - $50 |
| Signaling (Firestore) | ~100K documents/شهر | $5 |
| Bandwidth (WebRTC P2P) | معظمه P2P (مجاني) | $0 - $10 |
| Push Notifications | FCM (مجاني) | $0 |
| **الإجمالي** | | **$25 - $65** |

**ملاحظة:** التكلفة الرئيسية تأتي من TURN servers عندما يفشل P2P connection (خلف firewall). التحسين يكون بـ:
- استخدام STUN بشكل أساسي (مجاني)
- TURN فقط للحالات الضرورية
- تقليل جودة الفيديو لتقليل bandwidth

#### خطة التنفيذ المقترحة

**المرحلة 1: مكالمات صوتية فقط (4 أسابيع)**
1. الأسبوع 1: إعداد WebRTC infrastructure
   - إعداد STUN/TURN servers
   - إنشاء Signaling service (Firestore)
   - اختبار P2P connection
2. الأسبوع 2: تنفيذ واجهة المكالمات
   - شاشة إجراء المكالمة
   - شاشة استقبال المكالمة
   - controls (كتم الصوت، إنهاء)
3. الأسبوع 3: Push notifications للمكالمات
   - FCM integration للمكالمات الواردة
   - Call notification UI
4. الأسبوع 4: اختبار وتحسين
   - اختبار على شبكات مختلفة
   - معالجة حالات الفشل
   - تحسين جودة الصوت

**المرحلة 2: إضافة الفيديو (2 أسبوع)**
1. الأسبوع 5: دعم video streams
   - طلب أذونات الكاميرا
   - video rendering
   - camera switching
2. الأسبوع 6: adaptive quality
   - قياس جودة الشبكة
   - تغيير resolution تلقائياً
   - fallback إلى صوت فقط

**المرحلة 3: ميزات متقدمة (اختياري - 2 أسبوع)**
1. الأسبوع 7: مكالمات جماعية
   - SFU (Selective Forwarding Unit) server
   - دعم حتى 8 مشاركين
2. الأسبوع 8: تحسينات إضافية
   - screen sharing
   - call recording
   - blur background

#### تقدير التكلفة حسب عدد المستخدمين

| عدد المستخدمين | متوسط المكالمات/يوم | التكلفة الشهرية |
|----------------|---------------------|-----------------|
| 1K | 100 مكالمة | $25 - $50 |
| 10K | 1K مكالمة | $100 - $200 |
| 100K | 10K مكالمة | $500 - $1,000 |
| 1M | 100K مكالمة | $3,000 - $5,000 |

**ملاحظة:** هذه تقديرات تقريبية. التكلفة الفعلية تعتمد على:
- نسبة المكالمات التي تحتاج TURN (خلف firewall)
- متوسط مدة المكالمة
- جودة الفيديو المستخدمة
- استخدام P2P vs relay

#### بدائل منخفضة التكلفة

**خيار 1: Agora.io (Managed WebRTC)**
- 10,000 دقيقة مجانية شهرياً
- $0.99 لكل 1000 دقيقة بعد ذلك
- سهل التنفيذ (SDK جاهز)
- التكلفة المتوقعة: $50 - $200/شهر لـ 10K مستخدم

**خيار 2: Twilio Video (Enterprise)**
- جودة عالية جداً
- دعم فني ممتاز
- $0.004/دقيقة/مشارك (مكالمات P2P)
- $0.016/دقيقة/مشارك (مكالمات جماعية)
- التكلفة المتوقعة: $200 - $500/شهر لـ 10K مستخدم

**خيار 3: WebRTC مخصص + coturn (Self-hosted)**
- تكلفة منخفضة جداً
- تحكم كامل
- يتطلب خبرة تقنية عالية
- التكلفة المتوقعة: $50 - $100/شهر (سيرفر TURN فقط)

#### التوصية

**للمرحلة الحالية (< 50K مستخدم):**
- ✅ **لا تنفذ هذه الميزة الآن** - ركز على تحسين المميزات الأساسية
- ✅ انتظر حتى الوصول إلى 50K مستخدم نشط
- ✅ اجمع ملاحظات المستخدمين عن احتياجهم للمكالمات

**عند التنفيذ (> 50K مستخدم):**
- ✅ ابدأ بـ **Agora.io** (أسرع وأسهل)
- ✅ بعد اختبار الطلب، انتقل إلى **WebRTC مخصص** لتقليل التكلفة
- ✅ استخدم **coturn self-hosted** عند الوصول إلى 200K+ مستخدم

#### مراجع مفيدة

- [WebRTC Documentation](https://webrtc.org/)
- [Agora Flutter SDK](https://docs.agora.io/en/video-calling/get-started/get-started-sdk)
- [coturn TURN Server](https://github.com/coturn/coturn)
- [Flutter WebRTC Package](https://pub.dev/packages/flutter_webrtc)
- [Twilio Programmable Video](https://www.twilio.com/docs/video)
